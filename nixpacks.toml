# nixpacks.toml

# 1. Usamos proveedores automáticos (tu preferencia optimizada)
providers = ["python", "node"]

[phases.setup]
# Librerías básicas para procesamiento de imágenes (sin las pesadas de X11)
aptPkgs = ["libjpeg-dev", "zlib1g-dev", "libpng-dev", "libzbar-dev", "ghostscript", "gcc"]

[phases.install]
# 1. Creamos el entorno virtual.
# 2. Instalamos tus requerimientos.
# 3. TRUCO DE ORO: Desinstalamos 'opencv-python' y forzamos 'opencv-python-headless'.
# 4. Instalamos dependencias de Node para que Reflex no falle.
cmds = [
    "python -m venv --copies /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
    ". /opt/venv/bin/activate && pip uninstall -y opencv-python && pip install opencv-python-headless",
    "npm ci"
]

[start]
# Usamos la ruta ABSOLUTA para evitar el error "reflex: command not found"
cmd = "/opt/venv/bin/python -m reflex run --env prod --backend-only"

[variables]
# Puerto 8000 para el backend
PORT = "8000"