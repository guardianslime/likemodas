# nixpacks.toml

# Usamos proveedores automáticos (Python + Node)
providers = ["python", "node"]

[phases.setup]
# Lista EXTENDIDA de librerías del sistema para arreglar "libxcb.so.1"
aptPkgs = [
    # Librerías básicas gráficas
    "libgl1", "libglib2.0-0", "libsm6", "libxext6", "libxrender1",
    # Procesamiento de imágenes y ZBar
    "libjpeg-dev", "zlib1g-dev", "libpng-dev", "libzbar-dev", "ghostscript", "gcc",
    # --- EL FIX DE OPENCV ---
    # Instalamos todas las dependencias posibles de XCB
    "libxcb1",
    "libx11-xcb1",
    "libxcb-render0",
    "libxcb-shape0",
    "libxcb-xfixes0"
]

[phases.install]
# Instalación segura en entorno virtual
cmds = [
    "python -m venv --copies /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
    # --- LIMPIEZA DE SEGURIDAD ---
    # Desinstalamos la versión gráfica si alguna librería la trajo, y reinstalamos headless
    ". /opt/venv/bin/activate && pip uninstall -y opencv-python || true",
    ". /opt/venv/bin/activate && pip install --force-reinstall opencv-python-headless",
    "npm ci"
]

[start]
# Arrancamos usando la ruta absoluta al python del entorno virtual
cmd = "/opt/venv/bin/python -m reflex run --env prod --backend-only"

[variables]
OPENCV_VIDEOIO_PRIORITY_MSMF = "0"
# Puerto del backend
PORT = "8000"