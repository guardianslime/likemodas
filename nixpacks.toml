# nixpacks.toml

providers = ["python", "node"]

[phases.setup]
# Mantenemos solo lo esencial para que la descarga sea rápida y no falle
aptPkgs = [
    "libgl1", "libglib2.0-0", "libsm6", "libxext6", "libxrender1",
    "libjpeg-dev", "zlib1g-dev", "libpng-dev", 
    "ghostscript", "gcc",
    "libzbar0"  # La librería que instalamos
]

[phases.install]
cmds = [
    "python -m venv --copies /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
    
    # --- EL FIX DE ORO ---
    # Creamos un "acceso directo" llamado libzbar.so que apunta al archivo real libzbar.so.0
    # Esto hace que pyzbar la encuentre inmediatamente.
    "ln -sf /usr/lib/x86_64-linux-gnu/libzbar.so.0 /usr/lib/libzbar.so",
    
    "npm ci"
]

[start]
cmd = "/opt/venv/bin/python -m reflex run --env prod --backend-only"

[variables]
# Nos aseguramos de que el sistema busque en las carpetas correctas
LD_LIBRARY_PATH = "/usr/lib:/usr/lib/x86_64-linux-gnu"
OPENCV_VIDEOIO_PRIORITY_MSMF = "0"
PORT = "8000"