# nixpacks.toml

# 1. Proveedores automáticos (lo mantenemos igual)
providers = ["python", "node"]

[phases.setup]
# 2. Añadimos 'zbar-tools' y 'pkg-config' para ayudar a la detección
aptPkgs = [
    "libgl1", "libglib2.0-0", "libsm6", "libxext6", "libxrender1", # Gráficos base
    "libjpeg-dev", "zlib1g-dev", "libpng-dev", "ghostscript", "gcc", # Imágenes
    "libzbar0",      # La librería esencial
    "libzbar-dev",   # Headers de desarrollo
    "zbar-tools",    # <--- NUEVO: Herramientas extra para asegurar instalación
    "pkg-config"     # <--- NUEVO: Ayuda a Python a encontrar librerías C
]

[phases.install]
# 3. Instalación estándar
cmds = [
    "python -m venv --copies /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
    "npm ci"
]

[start]
# 4. Comando de inicio (sin cambios)
cmd = "/opt/venv/bin/python -m reflex run --env prod --backend-only"

[variables]
# 5. EL FIX DEFINITIVO: Le decimos al sistema dónde buscar 'libzbar.so'
# Ubuntu/Debian guardan las librerías aquí, y pyzbar a veces se pierde sin esto.
LD_LIBRARY_PATH = "/usr/lib/x86_64-linux-gnu:/usr/lib"

OPENCV_VIDEOIO_PRIORITY_MSMF = "0"
PORT = "8000"