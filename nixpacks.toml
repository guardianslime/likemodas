# nixpacks.toml
# Configuración Híbrida Definitiva (Python + Node + Librerías Gráficas)

[phases.setup]
# Instalamos Python 3.11, Pip explícito y Node.js
nixPkgs = [
    "python311", 
    "python311Packages.pip", 
    "nodejs", 
    "ffmpeg", 
    "zlib", 
    "unzip"
]

# Librerías de sistema Linux para OpenCV (fix libGL error)
aptPkgs = [
    "libgl1", 
    "libglib2.0-0", 
    "libsm6", 
    "libxext6", 
    "libxrender1"
]

[phases.install]
# 1. Usamos 'python3' explícitamente para evitar conflictos.
# 2. Instalamos también las dependencias de Node ('npm ci') porque Reflex las necesita.
cmds = [
    "python3 -m pip install --upgrade pip",
    "python3 -m pip install -r requirements.txt",
    "npm ci"
]

[start]
# Arrancamos usando el módulo de Python directamente
cmd = "python3 -m reflex run --env prod --backend-only"

[variables]
# Variables de entorno críticas
OPENCV_VIDEOIO_PRIORITY_MSMF = "0"
PYTHONUNBUFFERED = "1"
PORT = "8000"