# nixpacks.toml

# Usamos proveedores automáticos para Python y Node
providers = ["python", "node"]

[phases.setup]
# Aquí está la solución: Agregamos TODAS las variantes de libxcb que faltaban.
aptPkgs = [
    # Dependencias gráficas base
    "libgl1", 
    "libglib2.0-0", 
    "libsm6", 
    "libxext6", 
    "libxrender1",
    
    # Dependencias para procesamiento de imágenes y QR
    "libjpeg-dev", 
    "zlib1g-dev", 
    "libpng-dev", 
    "libzbar-dev", 
    "ghostscript", 
    "gcc",
    
    # --- EL FIX PARA EL ERROR ACTUAL (libxcb) ---
    "libxcb1",
    "libx11-xcb1",
    "libxcb-render0",   # Necesaria para Python 3.12 + OpenCV
    "libxcb-shape0",    # Necesaria para Python 3.12 + OpenCV
    "libxcb-xfixes0"    # Necesaria para Python 3.12 + OpenCV
]

[phases.install]
# Instalación robusta en entorno virtual
cmds = [
    "python -m venv --copies /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
    
    # Medida de seguridad: Forzamos la desinstalación de la versión GUI si se coló
    ". /opt/venv/bin/activate && pip uninstall -y opencv-python || true",
    
    "npm ci"
]

[start]
# Arrancamos usando la ruta absoluta al python del entorno virtual
cmd = "/opt/venv/bin/python -m reflex run --env prod --backend-only"

[variables]
OPENCV_VIDEOIO_PRIORITY_MSMF = "0"
PORT = "8000"